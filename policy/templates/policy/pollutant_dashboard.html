{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pollutant Dashboard</title>

<link rel="stylesheet" href="{% static 'css/style.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
function toggleTheme() {
    document.body.classList.toggle("dark-theme");
    const isDark = document.body.classList.contains("dark-theme");
    localStorage.setItem("theme", isDark ? "dark" : "light");
    document.getElementById("theme-icon").className = isDark ? "fas fa-sun" : "fas fa-moon";
}
window.onload = () => {
    if (localStorage.getItem("theme") === "dark") {
        document.body.classList.add("dark-theme");
        document.getElementById("theme-icon").className = "fas fa-sun";
    }
};
</script>

<style>
:root {--bg-color:#f4f6f9;--nav-bg:linear-gradient(90deg,#3b82f6,#8b5cf6);--sidebar-bg:#fff;--card-bg:#fff;--text-color:#111827;--muted-text:#6b7280;--border-color:#e5e7eb;--hover-bg:#e0e7ff;}
.dark-theme {--bg-color:#0f172a;--nav-bg:linear-gradient(90deg,#020617,#1e1b4b);--sidebar-bg:#020617;--card-bg:#1e293b;--text-color:#e5e7eb;--muted-text:#9ca3af;--border-color:#334155;--hover-bg:#1e40af;}
body{margin:0;font-family:Arial,sans-serif;background:var(--bg-color);color:var(--text-color);transition:background 0.3s,color 0.3s;}
.top-nav{background:var(--nav-bg);color:white;padding:15px 25px;display:flex;justify-content:space-between;align-items:center;}
.top-nav h2{margin:0;}
.nav-actions a{margin-left:15px;color:white;text-decoration:none;background:rgba(255,255,255,0.15);padding:8px 14px;border-radius:20px;font-size:14px;}
.nav-actions a:hover{background:rgba(255,255,255,0.3);}
.layout{display:flex;height:calc(100vh - 70px);}
.sidebar{width:240px;background:var(--sidebar-bg);padding:20px;border-right:1px solid var(--border-color);}
.sidebar h4{margin-bottom:15px;color:var(--text-color);}
.sidebar a{display:block;padding:10px 12px;margin-bottom:6px;text-decoration:none;color:var(--text-color);border-radius:6px;font-size:14px;}
.sidebar a:hover,.sidebar a.active{background:var(--hover-bg);color:white;font-weight:bold;}
.main-content{flex:1;padding:25px;overflow-y:auto;background:var(--bg-color);}
.cards{display:flex;flex-wrap:wrap;gap:20px;margin-bottom:25px;}
.card{background:var(--card-bg);padding:20px;border-radius:10px;box-shadow:0 3px 6px rgba(0,0,0,0.1);flex:1 1 200px;min-width:180px;transition:transform 0.2s;}
.card:hover{transform:translateY(-5px);}
.card h3{margin:0 0 10px 0;}
.card p{margin:5px 0;color:var(--muted-text);}
.charts{display:flex;flex-wrap:wrap;gap:25px;}
.chart-container{background:var(--card-bg);padding:20px;border-radius:10px;flex:1 1 400px;min-width:300px;}
.alerts{margin-top:25px;padding:15px 20px;background:#fde2e2;border-left:5px solid #f87171;border-radius:8px;color:#991b1b;}
</style>
</head>
<body>

<div class="top-nav">
    <div>
        <h2>Pollutant Dashboard</h2>
        <small>Air Quality & Health Insights</small>
    </div>
    <div class="nav-actions">
        <a href="#">Policy Dashboard</a>
        <a href="#">My Alerts</a>
        <a href="#">Profile</a>
        <a href="{% url 'logout' %}">Logout</a>
        <a href="#" onclick="toggleTheme()" title="Toggle Theme">
            <i id="theme-icon" class="fas fa-moon"></i>
        </a>
    </div>
</div>

<div class="layout">
    <div class="sidebar">
        <h4>Analysis Modules</h4>
        <a href="{% url 'source_attribution' %}">Source Attribution</a>
        <a href="{% url 'policy_simulation' %}">Policy Simulation</a>
        <a href="#" class="active">Pollutant Dashboard</a>
        <a href="#">Historical Trends</a>
        <a href="#">Satellite Data</a>
        <a href="#">AQI Forecast</a>
        <a href="#">Station Details</a>
    </div>

    <div class="main-content">

        <!-- Hardcoded Pollutant Cards -->
        <div class="cards">
            <div class="card">
                <h3>PM2.5</h3>
                <p id="pm25-value">-- µg/m³</p>
                <p>Status: <span id="pm25-status">--</span></p>
                <p>Trend: <span id="pm25-trend">--</span></p>
            </div>
            <div class="card">
                <h3>PM10</h3>
                <p id="pm10-value">-- µg/m³</p>
                <p>Status: <span id="pm10-status">--</span></p>
                <p>Trend: <span id="pm10-trend">--</span></p>
            </div>
            <div class="card">
                <h3>NO2</h3>
                <p id="no2-value">-- ppb</p>
                <p>Status: <span id="no2-status">--</span></p>
                <p>Trend: <span id="no2-trend">--</span></p>
            </div>
            <div class="card">
                <h3>SO2</h3>
                <p id="so2-value">-- ppb</p>
                <p>Status: <span id="so2-status">--</span></p>
                <p>Trend: <span id="so2-trend">--</span></p>
            </div>
            <div class="card">
                <h3>CO</h3>
                <p id="co-value">-- ppm</p>
                <p>Status: <span id="co-status">--</span></p>
                <p>Trend: <span id="co-trend">--</span></p>
            </div>
            <div class="card">
                <h3>O3</h3>
                <p id="o3-value">-- ppb</p>
                <p>Status: <span id="o3-status">--</span></p>
                <p>Trend: <span id="o3-trend">--</span></p>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts">
            <div class="chart-container">
            <h3>PM2.5 Trend (Last 1 hour)</h3>
            <canvas id="pm25Chart"></canvas>
            </div>
            <div class="chart-container">
                <h3>PM10 Trend (Last 1 hour)</h3>
                <canvas id="pm10Chart"></canvas>
            </div>
    </div>

        <!-- Alerts -->
        <div class="alerts" id="alert-msg">
            ⚠️ PM2.5 levels are above safe limits! People with respiratory issues should avoid outdoor activity.
        </div>

    </div>
</div>

<script>
let pm25Chart, pm10Chart;

// Store previous values for trend calculation
let lastValues = { 'PM2.5': [], 'PM10': [], 'NO2': [], 'SO2': [], 'CO': [], 'O3': [] };

window.onload = () => {
    const labels = [];
    const pm25Data = [];
    const pm10Data = [];

    const pm25Ctx = document.getElementById('pm25Chart').getContext('2d');
    pm25Chart = new Chart(pm25Ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'PM2.5', data: pm25Data, borderColor: 'red', fill: false }] },
        options: { responsive: true, scales: { x: { title: { display: true, text: 'Time' } } } }
    });

    const pm10Ctx = document.getElementById('pm10Chart').getContext('2d');
    pm10Chart = new Chart(pm10Ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: 'PM10', data: pm10Data, borderColor: 'blue', fill: false }] },
        options: { responsive: true, scales: { x: { title: { display: true, text: 'Time' } } } }
    });

    fetchLiveData();
    setInterval(fetchLiveData, 60000); // every 1 min
};

async function fetchLiveData() {
    try {
        const data = await fetch("{% url 'live_pollutants' %}").then(r => r.json());

        const now = new Date();
        const timeLabel = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0');

        // Update charts
        updateChart(pm25Chart, timeLabel, data['PM2.5']);
        updateChart(pm10Chart, timeLabel, data['PM10']);

        // Update cards
        const mapping = { 'PM2.5':'pm25', 'PM10':'pm10', 'NO2':'no2', 'SO2':'so2', 'CO':'co', 'O3':'o3' };
        for (const [key, id] of Object.entries(mapping)) {
            const unit = (key==='CO'?' ppm': key.includes('PM')?' µg/m³':' ppb');
            const value = data[key];
            document.getElementById(id+'-value').innerText = value + unit;

            // ---------- STATUS LOGIC ----------
            let status = 'Good';
            if ((key==='PM2.5' && value>150) || (key==='PM10' && value>150)) status = 'Unhealthy ⚠️';
            else if ((key==='PM2.5' && value>100) || (key==='PM10' && value>100)) status = 'Moderate';
            else if (key==='NO2' && value>100) status = 'Unhealthy ⚠️';
            else if (key==='SO2' && value>75) status = 'Unhealthy ⚠️';
            else if (key==='CO' && value>9) status = 'Unhealthy ⚠️';
            else if (key==='O3' && value>100) status = 'Unhealthy ⚠️';
            document.getElementById(id+'-status').innerText = status;

            // ---------- TREND LOGIC ----------
            let trendText = 'Stable';
            const lastVals = lastValues[key];
            if (lastVals.length > 0) {
                const diff = value - lastVals[lastVals.length-1];
                if (diff > 0) trendText = 'Rising ↑';
                else if (diff < 0) trendText = 'Falling ↓';
            }
            document.getElementById(id+'-trend').innerText = trendText;

            // Save latest value for next trend calculation
            lastVals.push(value);
            if (lastVals.length > 10) lastVals.shift();
        }

        // Alert only for PM2.5 > 150
        document.getElementById('alert-msg').style.display = (data['PM2.5'] > 150) ? 'block' : 'none';

    } catch (err) {
        console.error("Failed to fetch live pollutants:", err);
    }
}
async function initCharts() {
    const res = await fetch("{% url 'last_hour_pollutants' %}");
    const data = await res.json();

    const labels = data.time;
    const pm25Data = data['PM2.5'];
    const pm10Data = data['PM10'];

    pm25Chart.data.labels = labels;
    pm25Chart.data.datasets[0].data = pm25Data;
    pm25Chart.update();

    pm10Chart.data.labels = labels;
    pm10Chart.data.datasets[0].data = pm10Data;
    pm10Chart.update();
}


// Helper to update chart
function updateChart(chart, label, value) {
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);
    if (chart.data.labels.length > 60) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
    }
    chart.update();
}
</script>

</body>
</html>
